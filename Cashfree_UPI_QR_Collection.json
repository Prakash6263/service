{
  "info": {
    "_postman_id": "cashfree-upi-qr-collection",
    "name": "Cashfree UPI QR Payment Collection",
    "description": "Cashfree UPI QR Code Payment Gateway APIs for BikeDoctor\n\nFlow:\n1. Dealer generates QR code after booking\n2. User scans QR with any UPI app\n3. Payment completed via webhook\n\nBase URL: http://localhost:8001\nPrefix: /bikedoctor/cashfree",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:8001",
      "type": "string"
    },
    {
      "key": "token",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "1. Generate UPI QR Code",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "token",
            "value": "{{token}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"booking_id\": \"68fc8781a2bb1e138c0e0e04\",\n  \"amount\": 1500,\n  \"customer_name\": \"John Doe\",\n  \"customer_email\": \"john@example.com\",\n  \"customer_phone\": \"9876543210\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/bikedoctor/cashfree/generate-qr",
          "host": ["{{baseUrl}}"],
          "path": ["bikedoctor", "cashfree", "generate-qr"]
        },
        "description": "Generate UPI QR Code for payment.\n\nCalled by Dealer App after booking is confirmed.\n\nRequired fields:\n- booking_id: MongoDB ObjectId of the booking\n- amount: Payment amount in INR (min 1)\n\nOptional fields (auto-fetched from booking if not provided):\n- customer_name\n- customer_email\n- customer_phone\n\nResponse includes:\n- qr_code: Base64 encoded QR image (data URL)\n- qr_code_raw: Raw base64 for mobile apps\n- upi_link: Direct UPI payment link\n- order_id: Unique order identifier\n- expiry_time: QR code validity (30 mins)"
      },
      "response": [
        {
          "name": "Success Response",
          "status": "OK",
          "code": 200,
          "body": "{\n  \"success\": true,\n  \"message\": \"UPI QR Code generated successfully\",\n  \"data\": {\n    \"order_id\": \"BIKEDOC_1702500000000_ABC123\",\n    \"cf_order_id\": 123456789,\n    \"payment_id\": \"507f1f77bcf86cd799439011\",\n    \"amount\": 1500,\n    \"currency\": \"INR\",\n    \"qr_code\": \"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...\",\n    \"qr_code_raw\": \"iVBORw0KGgoAAAANSUhEUgAA...\",\n    \"payment_session_id\": \"session_xxxxx\",\n    \"expiry_time\": \"2024-12-14T12:30:00.000Z\",\n    \"upi_link\": \"upi://pay?pa=merchant@upi&pn=BikeDoctor&am=1500&tr=BIKEDOC_123\",\n    \"status\": \"PENDING\",\n    \"booking_id\": \"68fc8781a2bb1e138c0e0e04\",\n    \"customer\": {\n      \"name\": \"John Doe\",\n      \"phone\": \"9876543210\"\n    }\n  }\n}"
        }
      ]
    },
    {
      "name": "2. Check Payment Status",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "token",
            "value": "{{token}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/bikedoctor/cashfree/status/:order_id",
          "host": ["{{baseUrl}}"],
          "path": ["bikedoctor", "cashfree", "status", ":order_id"],
          "variable": [
            {
              "key": "order_id",
              "value": "BIKEDOC_1702500000000_ABC123",
              "description": "Order ID returned from generate-qr"
            }
          ]
        },
        "description": "Check payment status by polling.\n\nCalled by Dealer App to check if user has completed payment.\n\nRecommended polling interval: 3-5 seconds\n\nStatus values:\n- PENDING: Waiting for payment\n- SUCCESS: Payment completed\n- FAILED: Payment failed\n- EXPIRED: QR code expired\n- CANCELLED: Payment cancelled"
      },
      "response": [
        {
          "name": "Payment Pending",
          "status": "OK",
          "code": 200,
          "body": "{\n  \"success\": true,\n  \"message\": \"Payment status fetched successfully\",\n  \"data\": {\n    \"order_id\": \"BIKEDOC_1702500000000_ABC123\",\n    \"order_status\": \"ACTIVE\",\n    \"local_status\": \"PENDING\",\n    \"amount\": 1500,\n    \"payment_method\": null,\n    \"transaction_id\": null,\n    \"is_paid\": false\n  }\n}"
        },
        {
          "name": "Payment Success",
          "status": "OK",
          "code": 200,
          "body": "{\n  \"success\": true,\n  \"message\": \"Payment status fetched successfully\",\n  \"data\": {\n    \"order_id\": \"BIKEDOC_1702500000000_ABC123\",\n    \"order_status\": \"PAID\",\n    \"local_status\": \"SUCCESS\",\n    \"amount\": 1500,\n    \"payment_method\": \"upi\",\n    \"transaction_id\": \"cf_123456789\",\n    \"is_paid\": true\n  }\n}"
        }
      ]
    },
    {
      "name": "3. Cashfree Webhook",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "x-webhook-signature",
            "value": "signature_from_cashfree"
          },
          {
            "key": "x-webhook-timestamp",
            "value": "1702500000"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"type\": \"PAYMENT_SUCCESS_WEBHOOK\",\n  \"data\": {\n    \"order\": {\n      \"order_id\": \"BIKEDOC_1702500000000_ABC123\",\n      \"order_status\": \"PAID\",\n      \"order_amount\": 1500,\n      \"order_currency\": \"INR\"\n    },\n    \"payment\": {\n      \"cf_payment_id\": \"cf_123456789\",\n      \"payment_status\": \"SUCCESS\",\n      \"payment_method\": \"upi\",\n      \"payment_group\": \"upi\",\n      \"bank_reference\": \"123456789012\",\n      \"payment_time\": \"2024-12-14T12:15:00+05:30\"\n    }\n  }\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/bikedoctor/cashfree/webhook",
          "host": ["{{baseUrl}}"],
          "path": ["bikedoctor", "cashfree", "webhook"]
        },
        "description": "Webhook endpoint called by Cashfree.\n\nDO NOT call this manually - it's triggered automatically by Cashfree when payment status changes.\n\nConfigure this URL in Cashfree Dashboard:\nhttps://your-domain.com/bikedoctor/cashfree/webhook\n\nWebhook events:\n- PAYMENT_SUCCESS_WEBHOOK\n- PAYMENT_FAILED_WEBHOOK\n- PAYMENT_USER_DROPPED_WEBHOOK"
      },
      "response": []
    },
    {
      "name": "4. Get Payment by Booking ID",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "token",
            "value": "{{token}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/bikedoctor/cashfree/booking/:booking_id",
          "host": ["{{baseUrl}}"],
          "path": ["bikedoctor", "cashfree", "booking", ":booking_id"],
          "variable": [
            {
              "key": "booking_id",
              "value": "68fc8781a2bb1e138c0e0e04",
              "description": "MongoDB ObjectId of the booking"
            }
          ]
        },
        "description": "Get payment details for a specific booking.\n\nUse this to check if a booking has an associated payment and its current status."
      },
      "response": []
    },
    {
      "name": "5. Regenerate QR Code",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "token",
            "value": "{{token}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/bikedoctor/cashfree/regenerate/:payment_id",
          "host": ["{{baseUrl}}"],
          "path": ["bikedoctor", "cashfree", "regenerate", ":payment_id"],
          "variable": [
            {
              "key": "payment_id",
              "value": "507f1f77bcf86cd799439011",
              "description": "MongoDB ObjectId of the payment record"
            }
          ]
        },
        "description": "Regenerate QR code for an existing pending payment.\n\nUse this if:\n- User didn't scan the previous QR in time\n- Need to show QR again on dealer app\n\nNote: If the original order has expired, this will return an error. Generate a new payment instead."
      },
      "response": []
    },
    {
      "name": "6. Cancel Payment",
      "request": {
        "method": "DELETE",
        "header": [
          {
            "key": "token",
            "value": "{{token}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/bikedoctor/cashfree/cancel/:order_id",
          "host": ["{{baseUrl}}"],
          "path": ["bikedoctor", "cashfree", "cancel", ":order_id"],
          "variable": [
            {
              "key": "order_id",
              "value": "BIKEDOC_1702500000000_ABC123",
              "description": "Order ID to cancel"
            }
          ]
        },
        "description": "Cancel a pending payment.\n\nCan only cancel payments that are not yet completed (SUCCESS status).\n\nUse this if:\n- Booking is cancelled\n- User wants to pay via different method\n- Payment needs to be regenerated with different amount"
      },
      "response": []
    },
    {
      "name": "7. Get All QR Payments",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "token",
            "value": "{{token}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/bikedoctor/cashfree/payments?status=&dealer_id=&page=1&limit=20&startDate=&endDate=",
          "host": ["{{baseUrl}}"],
          "path": ["bikedoctor", "cashfree", "payments"],
          "query": [
            {
              "key": "status",
              "value": "",
              "description": "Filter by status: PENDING, SUCCESS, FAILED, CANCELLED, EXPIRED"
            },
            {
              "key": "dealer_id",
              "value": "",
              "description": "Filter by dealer MongoDB ObjectId"
            },
            {
              "key": "page",
              "value": "1",
              "description": "Page number for pagination"
            },
            {
              "key": "limit",
              "value": "20",
              "description": "Records per page"
            },
            {
              "key": "startDate",
              "value": "",
              "description": "Filter from date (YYYY-MM-DD)"
            },
            {
              "key": "endDate",
              "value": "",
              "description": "Filter to date (YYYY-MM-DD)"
            }
          ]
        },
        "description": "Get all UPI QR payments with optional filters.\n\nUseful for:\n- Admin dashboard to view all QR payments\n- Dealer to view their payment history\n- Generating reports"
      },
      "response": []
    }
  ]
}
